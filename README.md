# COI Disclosure Portal (Bun.ts + Elysia + SQLite + React/Vite)

A minimal, secure, and maintainable web application for HL7-style Conflict of Interest (COI) disclosures.

- Backend: Bun.ts + Elysia, SQLite (via `bun:sqlite`), cookie-based sessions, OIDC via `openid-client`.
- Frontend: React + Vite (SPA).
- Reporting: One-click **Generate Public Report** (sanitized CSV) + **static site** generator in `public_site/`.
- Simplicity: No frameworks beyond Elysia and a handful of small libs; prepared statements used; ~well under 10k LOC.

> Note: You must supply your OIDC details and seed authorized users. See **Setup**.

## Setup

### 1) Prerequisites
- Bun >= 1.1 (https://bun.sh)
- (Optional) Node-compatible toolchain for building the React SPA (handled by Bun)

### 2) Configure environment
Copy `.env.sample` to `.env` and set values:
```bash
cp .env.sample .env
# then edit .env
```

### 3) Install dependencies
```bash
bun install
```

### 4) Initialize database and seed users
```bash
bun run scripts/seed.ts
```

### 5) Start server
```bash
MOCK_AUTH=true bun run src/server.ts
# visit http://localhost:3000
```

> The frontend is bundled automatically by Bun when you import `frontend/index.html` inside the server. No separate build step is required.

### 6) Admin: generate public outputs
In the Admin Dashboard click **Generate Public Report**, or run:
```bash
bun run scripts/generate_public.ts
# Outputs: ./public_disclosures.csv and ./public_site/
```

## Environment Variables
See `.env.sample` for a complete list. Required values typically include:
- APP_BASE_URL (e.g., http://localhost:3000)
- SESSION_SECRET (random string; at least 32 chars)
- OIDC_ISSUER (e.g., https://oidc.hl7.example)
- OIDC_CLIENT_ID
- OIDC_CLIENT_SECRET
- OIDC_REDIRECT_URI (e.g., http://localhost:3000/auth/callback)
- MOCK_AUTH (set to `true` to bypass OIDC during local testing; see below)

## Mocking OIDC locally
Set `MOCK_AUTH=true` in your environment to skip the external OIDC flow while testing. When enabled, use the mock login shortcuts on the home page or call `/auth/login` with explicit user details to create a session:

```
/auth/login?email=test@example.org&name=Test%20User&hl7_id=mock|1&org_role=TSC&admin=true
```

If `admin=true` is present, the user is marked as an admin. All parameters are optional except `email` when calling the endpoint directly.

## Security
- Passwords are never stored; OIDC-only login.
- Sessions use httpOnly, Secure cookies (set Secure=false on local dev if needed via env flag).
- SQL is executed via prepared statements to mitigate injection risks.
- Public outputs remove dollar amounts and private details; NDA-restricted items appear as sector + topic.

## Notes
- This project stores SQLite at `./data/app.db` (outside of any web root) and serves static files only from the Bun server (React app via HTML imports) and `./public_site` (the latter is intended for separate hosting).
- The static site is generated by reading **the sanitized CSV**, per policy.
- Feel free to evolve schema and UI to fit production workflows.
